import React, { useEffect, useMemo, useState } from "react";

/**
 * 推し活貯金・タスク ダッシュボード MVP
 * - ローカルストレージに保存
 * - 円形プログレス、貯金追加、タスク追加/完了、推しカラー切替
 * - 1ファイルでプレビュー可能
 */

// ---- Helpers ----
const KEY = {
  state: "oshiDash.miniState.v1",
};

const defaultState = {
  oshiName: "◯◯",
  message: "◯◯ちゃんが見てるよ👀",
  theme: "pink",
  balance: 3500,
  goal: 10000,
  tasks: [
    { id: "t1", title: "チケット抽選に応募する", done: true },
    { id: "t2", title: "SNSで推しツイートする", done: false },
    { id: "t3", title: "ダンス練習 30 分", done: false },
  ],
};

function usePersistentState() {
  const [state, setState] = useState(() => {
    try {
      const raw = localStorage.getItem(KEY.state);
      return raw ? JSON.parse(raw) : defaultState;
    } catch {
      return defaultState;
    }
  });
  useEffect(() => {
    localStorage.setItem(KEY.state, JSON.stringify(state));
  }, [state]);
  return [state, setState] as const;
}

// ---- UI Parts ----
function Card({ children, className = "" }) {
  return (
    <div className={`rounded-2xl shadow-sm border border-black/5 bg-white ${className}`}>{children}</div>
  );
}

function SectionTitle({ children }) {
  return <h3 className="text-sm font-medium text-black/60 mb-3">{children}</h3>;
}

function ProgressRing({ value, max, size = 160, stroke = 10 }) {
  const r = (size - stroke) / 2;
  const c = 2 * Math.PI * r;
  const pct = Math.max(0, Math.min(1, value / max));
  const dash = c * pct;
  return (
    <svg width={size} height={size} className="block">
      <circle cx={size / 2} cy={size / 2} r={r} stroke="#eee" strokeWidth={stroke} fill="none" />
      <circle
        cx={size / 2}
        cy={size / 2}
        r={r}
        stroke="currentColor"
        strokeWidth={stroke}
        fill="none"
        strokeLinecap="round"
        strokeDasharray={`${dash} ${c - dash}`}
        transform={`rotate(-90 ${size / 2} ${size / 2})`}
      />
      <text x="50%" y="48%" textAnchor="middle" className="fill-black text-[14px] font-semibold">
        {value.toLocaleString()}円
      </text>
      <text x="50%" y="64%" textAnchor="middle" className="fill-black/60 text-[12px]">
        / {max.toLocaleString()}円
      </text>
    </svg>
  );
}

function PillButton({ children, onClick, className = "" }) {
  return (
    <button
      onClick={onClick}
      className={`px-4 py-3 rounded-full font-semibold shadow-sm hover:shadow transition active:scale-[0.99] ${className}`}
    >
      {children}
    </button>
  );
}

// ---- Main Component ----
export default function App() {
  const [state, setState] = usePersistentState();
  const { oshiName, message, theme, balance, goal, tasks } = state;

  const completed = useMemo(() => tasks.filter((t) => t.done).length, [tasks]);

  const themeColor = useMemo(() => {
    switch (theme) {
      case "sky":
        return "text-sky-500 bg-sky-50 ring-sky-200";
      case "violet":
        return "text-violet-500 bg-violet-50 ring-violet-200";
      case "emerald":
        return "text-emerald-500 bg-emerald-50 ring-emerald-200";
      default:
        return "text-pink-500 bg-pink-50 ring-pink-200";
    }
  }, [theme]);

  function addDeposit() {
    const yen = prompt("いくら貯金する？（円）", "500");
    if (!yen) return;
    const n = Math.max(0, Math.floor(Number(yen)) || 0);
    setState({ ...state, balance: balance + n });
  }

  function addTask() {
    const title = prompt("新しいタスク内容は？", "推し配信をチェック");
    if (!title) return;
    setState({ ...state, tasks: [{ id: crypto.randomUUID(), title, done: false }, ...tasks] });
  }

  function toggleTask(id) {
    setState({
      ...state,
      tasks: tasks.map((t) => (t.id === id ? { ...t, done: !t.done } : t)),
    });
  }

  function removeTask(id) {
    setState({ ...state, tasks: tasks.filter((t) => t.id !== id) });
  }

  function editBasics() {
    const name = prompt("推しの呼び名", oshiName) ?? oshiName;
    const msg = prompt("メッセージ", message) ?? message;
    const g = prompt("目標金額（円）", String(goal));
    const newGoal = Math.max(1, Math.floor(Number(g) || goal));
    setState({ ...state, oshiName: name, message: msg, goal: newGoal });
  }

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-white to-rose-50 px-4 py-6 sm:py-10">
      <div className="max-w-md mx-auto">
        {/* Header */}
        <header className="mb-5 flex items-center gap-3">
          <div className={`w-12 h-12 rounded-2xl ring-4 ${themeColor} grid place-items-center font-bold`}>{oshiName.at(0)}</div>
          <div className="flex-1">
            <div className="text-xs text-black/60">{new Date().toLocaleDateString()}</div>
            <div className="text-xl font-bold">{message}</div>
          </div>
          <div className="flex gap-1">
            {(["pink", "sky", "violet", "emerald"] as const).map((t) => (
              <button
                key={t}
                onClick={() => setState({ ...state, theme: t })}
                className={`w-5 h-5 rounded-full border ${
                  t === theme ? "outline outline-2 outline-black/20" : ""
                } ${
                  t === "pink"
                    ? "bg-pink-400"
                    : t === "sky"
                    ? "bg-sky-400"
                    : t === "violet"
                    ? "bg-violet-500"
                    : "bg-emerald-500"
                }`}
                title={`テーマ：${t}`}
              />
            ))}
          </div>
        </header>

        {/* Savings */}
        <Card className="p-5 mb-5 text-center">
          <SectionTitle>貯金の進捗</SectionTitle>
          <div className={`mx-auto text-center ${themeColor} inline-block rounded-3xl p-3`}> 
            <ProgressRing value={balance} max={goal} />
          </div>
          <div className="mt-4 grid grid-cols-2 gap-3">
            <PillButton className="bg-black text-white" onClick={addDeposit}>貯金する ＋</PillButton>
            <PillButton className="bg-white border text-black" onClick={editBasics}>目標・文言を編集</PillButton>
          </div>
        </Card>

        {/* Tasks */}
        <Card className="p-5 mb-5">
          <div className="flex items-end justify-between mb-3">
            <SectionTitle>今日のタスク</SectionTitle>
            <div className="text-xs text-black/60">{completed}/{tasks.length} 完了</div>
          </div>
          <ul className="space-y-2">
            {tasks.map((t) => (
              <li key={t.id} className="flex items-center gap-3">
                <input
                  type="checkbox"
                  checked={t.done}
                  onChange={() => toggleTask(t.id)}
                  className="size-5 accent-pink-500"
                />
                <span className={`flex-1 ${t.done ? "line-through text-black/40" : ""}`}>{t.title}</span>
                <button onClick={() => removeTask(t.id)} className="text-black/40 text-sm hover:text-black">削除</button>
              </li>
            ))}
          </ul>
          <div className="mt-4">
            <PillButton className="bg-pink-500 text-white w-full" onClick={addTask}>タスクを追加</PillButton>
          </div>
        </Card>

        {/* Footer Nav (dummy) */}
        <nav className="sticky bottom-4 mt-6">
          <div className="mx-auto max-w-md">
            <div className="grid grid-cols-4 gap-3 bg-white/80 backdrop-blur border border-black/5 rounded-2xl p-2 shadow-sm">
              {[
                { label: "ホーム", emoji: "🏠" },
                { label: "貯金", emoji: "💰" },
                { label: "タスク", emoji: "✅" },
                { label: "設定", emoji: "⚙️" },
              ].map((i) => (
                <button key={i.label} className="py-2 text-sm rounded-xl hover:bg-black/5">
                  <div className="leading-none text-lg">{i.emoji}</div>
                  <div className="text-[11px] text-black/70">{i.label}</div>
                </button>
              ))}
            </div>
          </div>
        </nav>

        <div className="text-center text-xs text-black/40 mt-6">v0.1 – ローカル保存（ブラウザのみ）</div>
      </div>
    </div>
  );
}
